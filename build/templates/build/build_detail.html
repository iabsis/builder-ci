{% extends "layouts/base.html" %}
{% load static %}
{% load table %}
{% load crispy_forms_tags %}
{% load build humanize page %}

{% block content %}

<!-- Begin Page Content -->
<div class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">{{title|title}}</h1>

    <!-- DataTales Example -->

    <div class="row">
        <div class="col-6">

            <div class="card shadow mb-4">
                <div class= "card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Build information</h6>
                </div>
                <div class="card-body">

                    <div class="row">

                        <div class="col-4">

                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                ID</div>
                            <div class="h5 text-gray-800">{{object.pk}}</div>

                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Version</div>
                            <div class="h5 text-gray-800">
                                {{object.version|view_field}}
                            </div>

                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Status</div>
                            <div class="h5 text-gray-800">{{object.status|status_badge}}</div>

                        </div>    
                        <div class="col-8">

                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Started at
                            </div>
                            <div class="h6 text-gray-800">
                                <pre>{{object.started_at|naturaltime}}</pre>
                            </div>

                            {% if object.status != 'failed' %}
                                {% if object.finished_at %}
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Finished at
                                </div>
                                <div class="h6 text-gray-800">
                                    <pre>{{object.finished_at|naturaltime}}</pre>
                                </div>
                                {% else %}
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Eta
                                </div>
                                <div class="h6 text-gray-800">
                                    <pre>{{object.eta_at|naturaltime}}</pre>
                                </div>
                                {% endif %}
                            {% endif %}

                            {% if object.build_duration %}
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Build duration
                            </div>
                            <div class="h6 text-gray-800">
                                <pre>{{object.build_duration}}</pre>
                            </div>
                            {% endif %}


                            {% if object.status == 'running' and object.progress != None %}
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Progress
                                </div>

                                <div class="row no-gutters align-items-center mb-3">
                                    <div class="col-auto">
                                        <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{object.progress}}%</div>
                                    </div>
                                    <div class="col">
                                        <div class="progress progress-sm mr-2">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {{object.progress}}%" aria-valuenow="{{object.progress}}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            {% endif%}

                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Metadata
                            </div>
                            <div class="h6 text-gray-800">
                                <pre>{{object.meta|view_field}}</pre>   
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="col-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Build request</h6>
                </div>
                <div class="card-body">

                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Name</div>
                    <div class="h5 text-gray-800">
                        <a href="{% url 'request_view' object.request.pk %}">
                            {{object.request.name}}
                        </a>
                    </div>

                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Options
                    </div>
                    <div class="h6 text-gray-800">
                        <pre>{{object.options|view_field}}</pre>
                    </div>

                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Flow
                    </div>
                    <div class="h5 text-gray-800">
                        <a href="{% url 'flow_update' object.flow.pk %}">
                            {{object.flow}}
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Live stream</h6>
        </div>
        <div id="stream" class="card-body">
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Tasks info</h6>
        </div>
        <div class="card-body">

            <a href="{% url 'build_run' object.pk %}" class="btn btn-primary btn-icon-split mb-4">
                <span class="icon text-white-50">
                    <i class="fas fa-refresh"></i>
                </span>
                <span class="text">
                    Run again
                </span>
            </a>

            <div class="row no-gutters align-items-center">
                {% for task in object.buildtask_set.all %}
                <div class="col-12">
                    <div id="accordion">
                            <div class="card">
                                <div class="card-header" id="headingOne">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link" data-toggle="collapse" data-target="#collapse-{{task.pk}}" aria-expanded="false"
                                            aria-controls="collapseOne">
                                            TASK #{{task.order}} {{task.status|status_badge}}
                                            {% if task.method %}
                                                {% if not task.method.stop_on_failure %}
                                                    (Optional)
                                                {% endif %}
                                            {% endif %}
                                        </button>
                                        <span class="text-xs">{{task.description}}</span>
                                    </h5>
                                </div>
                        
                                <div id="collapse-{{task.pk}}" class="collapse {% if task.status == 'failed' %}show{% endif %}" aria-labelledby="headingOne" data-parent="#accordion">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                    Options</div>
                                                <div class="mb-0 text-gray-800">{{task.options}}</div>
                                            </div>
                                            <div class="col-12 mr-2 mt-3">
                                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                    Task log</div>
                                                <pre class="text-xs">{{task.logs|linebreaks}}</pre>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p>No task executed</p>
                {% endfor %}
            </div>
        </div>
    </div>



    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Celery info</h6>
        </div>
        <div class="card-body">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        ID</div>
                    <div class="h5 mb-0 text-gray-800">{{object.celery_task.task_id}}</div>
                </div>
                <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Status</div>
                    <div class="h5 mb-0 text-gray-800">{{object.celery_task.status}}</div>
                </div>
            </div>

            <div class="row no-gutters align-items-center mt-5">
                <p class="text-xs font-weight-bold text-primary text-uppercase mb-1">Traceback</p>
            </div>
            <div class="row no-gutters align-items-center">
                <code class="text-xs">{{object.celery_task.traceback|linebreaks}}</code>
            </div>
    
        </div>
    </div>

</div>


{% endblock content %}

{% block scripts %}
<script>

    function addTask(data) {
        const tasksContainer = document.getElementById("stream");
    
        const taskHTML = `
            <div class="col-12">
                <div id="accordion">
                    <div class="card">
                        <div class="card-header" id="headingOne">
                            <h5 class="mb-0">
                                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse-${data.task}" aria-expanded="true" aria-controls="collapse-${data.task}">
                                    TASK #${data.task} <span id="badge-${data.task}" class="ml-1 badge badge-success">${data.status}</span>
                                </button>
                                <span class="text-xs">${data.description}</span>
                            </h5>
                        </div>
                
                        <div id="collapse-${data.task}" class="collapse" aria-labelledby="heading-${data.task}" data-parent="#accordion">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Options</div>
                                        <div class="mb-0 text-gray-800"></div>
                                    </div>
                                    <div class="col-12 mr-2 mt-3">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Task log
                                        </div>
                                        <pre class="text-xs"></pre>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        tasksContainer.insertAdjacentHTML("beforeend", taskHTML);
    }

    function toogleTask(taskId, state) {
        const collapseElement = document.getElementById(`collapse-${taskId}`);
    
        if (collapseElement) {
            const collapseInstance = new Bootstrap.Collapse(collapseElement, {
                toggle: false
            });
            if (state === "show") {
                collapseInstance.show();
            } else {
                collapseInstance.hide();
            }
        }
    }
    
    const buildPk = {{object.pk}};

    const taskSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/logs/'
        + buildPk
        + '/'
    );

    taskSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.action === "create_task") {
            addTask(data);
        //} else if (data.action === "update_task") {
        //    toogleTask(data.task, 'show');
        } else if (data.action === "open_task") {
            toogleTask(data.task, 'show');
        } else if (data.action === "close_task") {
            toogleTask(data.task, 'hide');
        }
        // document.getElementById('stream').innerHTML += ('<p>' + data.description + '</p>');
        console.log(data)
    };

    taskSocket.onclose = function(e) {
        console.error('Logs socket closed unexpectedly');
    };

</script>
{% endblock %}